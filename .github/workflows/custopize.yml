name: "Build image"

on:
  workflow_dispatch:
    inputs:
      octoprint_version:
        description: "OctoPrint version (leave empty to use latest stable release)"
        required: false
        default: ''

jobs:
  build:
    name: "Build"
    runs-on: ubuntu-latest
    steps:

    - name: "⬇ Checkout"
      uses: actions/checkout@v2

    - name: "⬇ Download latest OctoPi"
      id: octopi_download
      run: |
        mkdir build
        cd build
        wget https://github.com/guysoft/OctoPi/releases/download/0.18.0/octopi-buster-armhf-lite-0.18.0.zip
        
        find . -name "*.zip" -exec unzip {} \;
        rm *.zip

        IMAGE=$(ls *.img | head -n 1)
        mv $IMAGE input.img

        OCTOPI_VERSION=$(basename -s .img $IMAGE | awk -F"-" '{print $NF}')
        echo "OCTOPI_VERSION=$OCTOPI_VERSION" >> $GITHUB_ENV

    - name: "🔎 Determine OctoPrint version"
      run: |
        OCTOPRINT_VERSION="${{ github.event.inputs.octoprint_version }}"
        if [ -z "$OCTOPRINT_VERSION" ]; then
          OCTOPRINT_VERSION=$(curl https://pypi.org/pypi/OctoPrint/json -s | jq -r '.info.version')
        fi
        echo "OCTOPRINT_VERSION=$OCTOPRINT_VERSION" >> $GITHUB_ENV

    - name: "🏗 Run CustoPiZer"
      run: |
        sudo modprobe loop
        docker run --rm --privileged \
          -e OCTOPRINT_VERSION=${{ env.OCTOPRINT_VERSION }} \
          -v ${{ github.workspace }}/build:/CustoPiZer/workspace \
          -v ${{ github.workspace }}/scripts:/CustoPiZer/workspace/scripts \
          ghcr.io/octoprint/custopizer:latest

    - name: "📦 Package up the image"
      run: |
        OCTOPI_VERSION="${{ env.OCTOPI_VERSION }}"
        OCTOPRINT_VERSION="${{ env.OCTOPRINT_VERSION }}"
        
        IMAGE="octopi-$OCTOPI_VERSION-$OCTOPRINT_VERSION.img"
        echo "IMAGE=$IMAGE" >> $GITHUB_ENV

        cd build
        mv output.img $IMAGE
        zip $IMAGE.zip $IMAGE
        md5sum $IMAGE.zip > $IMAGE.zip.md5
        sha256sum $IMAGE.zip > $IMAGE.zip.sha256

    #- name: ⬆ Upload output image
    #  uses: actions/upload-artifact@v1
    #  with:
    #    name: output.img
    #    path: build/output.img

    - name: "🔖 Create release & attach assets"
      uses: softprops/action-gh-release@v1
      with:
        name: "OctoPi ${{ env.OCTOPI_VERSION }} with OctoPrint ${{ env.OCTOPRINT_VERSION }}"
        tag_name: "${{ env.OCTOPI_VERSION }}-${{ env.OCTOPRINT_VERSION }}"
        body: "Created with [CustoPiZer](https://github.com/OctoPrint/CustoPiZer)"
        files: |
          build/${{ env.IMAGE }}.zip
          build/${{ env.IMAGE }}.zip.md5
          build/${{ env.IMAGE }}.zip.sha256
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}